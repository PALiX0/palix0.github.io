<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Overall Standings</title>
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css">
</head>
<body>
    <div class="container my-4">
        <h1>Overall Standings for Ev_01</h1>
        <p>This page dynamically calculates the overall standings from available stage results CSV files in the <code>csv/</code> folder.</p>
        <table id="standingsTable" class="table table-striped">
            <thead>
                <tr>
                    <th>Rank</th>
                    <th>Display Name</th>
                    <th>Total Time (s)</th>
                    <th>Penalty Minutes (s)</th>
                    <th>Is Retired</th>
                </tr>
            </thead>
            <tbody>
                <!-- Dynamic rows will be inserted here -->
            </tbody>
        </table>
    </div>
    <script>
        const csvFolder = "csv/Ch_W05/Ev_01/"; // Path to the folder containing CSV files

        // Function to list and filter CSV files
        async function listCSVFiles() {
            const response = await fetch(csvFolder);
            const text = await response.text();
            const parser = new DOMParser();
            const doc = parser.parseFromString(text, "text/html");
            const files = Array.from(doc.querySelectorAll("a"))
                .map(link => link.href)
                .filter(file => file.match(/.*_stage\d+_leaderboard_results\.csv$/)); // Updated regex
            return files;
        }

        // Function to convert time in HH:MM:SS format to seconds
        function timeToSeconds(timeStr) {
            const [h, m, s] = timeStr.split(':').map(Number);
            return h * 3600 + m * 60 + s;
        }

        // Function to fetch and parse a CSV file
        async function fetchCSV(file) {
            const response = await fetch(file);
            const text = await response.text();
            const rows = text.trim().split('\n').slice(1); // Skip header
            return rows.map(row => {
                const [rank, displayName, vehicle, time, penalty, difference, platform] = row.split(',');
                return {
                    displayName,
                    time: timeToSeconds(time),
                    penalty: timeToSeconds(penalty)
                };
            });
        }

        // Main function to calculate standings
        async function calculateStandings() {
            const csvFiles = await listCSVFiles();
            const playerTimes = {};

            for (const file of csvFiles) {
                const stageResults = await fetchCSV(csvFolder + file);
                for (const { displayName, time, penalty } of stageResults) {
                    if (!playerTimes[displayName]) {
                        playerTimes[displayName] = { totalTime: 0, penaltyMinutes: 0, isRetired: false };
                    }
                    playerTimes[displayName].totalTime += time + penalty;
                }
            }

            const standings = Object.entries(playerTimes).map(([displayName, { totalTime, penaltyMinutes, isRetired }]) => ({
                displayName,
                totalTime,
                penaltyMinutes,
                isRetired
            }));

            standings.sort((a, b) => a.totalTime - b.totalTime);

            const tableBody = document.querySelector('#standingsTable tbody');
            tableBody.innerHTML = standings.map((player, index) => `
                <tr>
                    <td>${index + 1}</td>
                    <td>${player.displayName}</td>
                    <td>${player.totalTime}</td>
                    <td>${player.penaltyMinutes}</td>
                    <td>${player.isRetired ? 'Yes' : 'No'}</td>
                </tr>
            `).join('');
        }

        // Initialize the standings calculation
        calculateStandings();
    </script>
</body>
</html>
