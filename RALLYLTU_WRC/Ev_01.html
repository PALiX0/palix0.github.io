<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Ev_01 Overall Standings</title>
    <style>
        table {
            border-collapse: collapse;
            width: 100%;
        }
        th, td {
            border: 1px solid black;
            padding: 8px;
            text-align: left;
        }
        th {
            background-color: #f2f2f2;
        }
    </style>
</head>
<body>
    <h1>Ev_01 Overall Standings</h1>
    <p id="debugInfo"></p>
    <table id="standings">
        <thead>
            <tr>
                <th>Power Stage Points</th>
                <th>Event Points</th>
                <th>Position</th>
                <th>Driver</th>
                <th>Total Time</th>
                <th>Time Difference to First</th>
                <th>Total Time Penalty</th>
                <th>DNF</th>
                <th>Stages Completed</th>
                <th>Platform</th>
            </tr>
        </thead>
        <tbody>
        </tbody>
    </table>

    <script>
        async function fetchJSON(url) {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Failed to fetch JSON: ${url}`);
            }
            return response.json();
        }

        async function fetchCSV(url) {
            const response = await fetch(url);
            if (!response.ok) {
                throw new Error(`Failed to fetch CSV: ${url}`);
            }
            return response.text();
        }

        function parseCSV(data) {
            const rows = data.split("\n").map(row => row.trim()).filter(row => row);
            const headers = rows[0].split(",").map(header => header.trim());
            const dataRows = rows.slice(1);

            // Dynamic index mapping
            const rankIndex = headers.indexOf("Rank");
            const driverIndex = headers.indexOf("DisplayName");
            const timeIndex = headers.indexOf("Time");
            const penaltyIndex = headers.indexOf("TimePenalty");
            const platformIndex = headers.indexOf("Platform");

            return dataRows.map(row => {
                const cells = row.split(",").map(cell => cell.trim());
                return {
                    rank: parseInt(cells[rankIndex], 10),
                    driver: cells[driverIndex],
                    time: cells[timeIndex],
                    penalty: parseTimeToSeconds(cells[penaltyIndex] || "00:00:00"),
                    platform: cells[platformIndex],
                };
            });
        }

        function parseTimeToSeconds(time) {
            const [hh, mm, ssWithMs] = time.split(":");
            const [ss, ms = "0"] = ssWithMs.split(".");
            return (
                parseInt(hh, 10) * 3600 +
                parseInt(mm, 10) * 60 +
                parseInt(ss, 10) +
                parseFloat(`0.${ms}`)
            );
        }

        function formatSecondsToTime(totalSeconds) {
            const hours = Math.floor(totalSeconds / 3600);
            const minutes = Math.floor((totalSeconds % 3600) / 60);
            const seconds = (totalSeconds % 60).toFixed(3);
            return `${String(hours).padStart(2, "0")}:${String(minutes).padStart(2, "0")}:${String(seconds).padStart(6, "0")}`;
        }

        async function fetchPoints() {
            const pointsData = await fetchCSV("/RALLYLTU_WRC/points/points_top20.csv");
            return pointsData.split("\n").reduce((pointsMap, row) => {
                const [position, points] = row.split(",").map(Number);
                pointsMap[position] = points;
                return pointsMap;
            }, {});
        }

        async function listCSVFiles() {
            const fileList = await fetchJSON("/RALLYLTU_WRC/csv/Ch_W05/Ev_01/file_list.json");
            return fileList.map(file => `/RALLYLTU_WRC/csv/Ch_W05/Ev_01/${file}`);
        }

        async function generateStandings() {
            const files = await listCSVFiles();
            const pointsMap = await fetchPoints();
            const standings = {};
            let lastStageResults = [];

            for (const [index, file] of files.entries()) {
                const csvData = await fetchCSV(file);
                const stageResults = parseCSV(csvData);

                if (index === files.length - 1) lastStageResults = stageResults;

                stageResults.forEach(({ rank, driver, time, penalty, platform }) => {
                    const totalSeconds = parseTimeToSeconds(time);

                    const player = standings[driver] || {
                        totalTime: 0,
                        penaltyTime: 0,
                        stagesCompleted: 0,
                        platform,
                        dnf: false,
                    };
                    player.totalTime += totalSeconds;
                    player.penaltyTime += penalty;
                    player.stagesCompleted += 1;
                    player.dnf = time === "08:00:00" || time === "16:00:00" || time === "25:00:00";
                    standings[driver] = player;
                });
            }

            // Sort standings by total time
            const sortedStandings = Object.entries(standings)
                .sort(([, a], [, b]) => (a.dnf ? Infinity : a.totalTime + a.penaltyTime) - (b.dnf ? Infinity : b.totalTime + b.penaltyTime))
                .map(([driver, data], index) => ({
                    position: data.dnf ? "-" : index + 1,
                    driver,
                    totalTime: data.dnf ? "DNF" : formatSecondsToTime(data.totalTime),
                    timeDiff: data.dnf ? "-" : formatSecondsToTime(data.totalTime - sortedStandings[0][1].totalTime),
                    totalPenalty: data.penaltyTime,
                    stagesCompleted: data.stagesCompleted,
                    platform: data.platform,
                    dnf: data.dnf ? "DNF" : "",
                    eventPoints: pointsMap[index + 1] || 0,
                }));

            const lastStagePowerPoints = lastStageResults.slice(0, 5).map((result, i) => ({
                driver: result.driver,
                powerStagePoints: 5 - i,
            }));

            const tbody = document.querySelector("#standings tbody");
            tbody.innerHTML = "";
            sortedStandings.forEach(({ powerStagePoints, eventPoints, position, driver, totalTime, timeDiff, totalPenalty, dnf, stagesCompleted, platform }) => {
                const row = `<tr>
                    <td>${powerStagePoints || 0}</td>
                    <td>${eventPoints}</td>
                    <td>${position}</td>
                    <td>${driver}</td>
                    <td>${totalTime}</td>
                    <td>${timeDiff}</td>
                    <td>${totalPenalty}</td>
                    <td>${dnf}</td>
                    <td>${stagesCompleted}</td>
                    <td>${platform}</td>
                </tr>`;
                tbody.innerHTML += row;
            });
        }

        async function main() {
            await generateStandings();
        }

        main();
    </script>
</body>
</html>
